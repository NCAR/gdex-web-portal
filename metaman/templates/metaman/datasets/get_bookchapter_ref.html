<script id="bookchapter_script" language="javascript">
function checkBookChapterForm() {
  var c;
  if (document.bookchapter_form.ds_rel.selectedIndex == 0) {
    alert("Choose how the dataset is related to this book chapter");
    return false;
  }
  if (document.bookchapter_form.authlist.value.length == 0) {
    alert("Enter the list of authors");
    return false;
  }

  // clean up author list
  var idx=document.bookchapter_form.authlist.value.indexOf(".  ");
  while (idx > 0) {
    document.bookchapter_form.authlist.value=document.bookchapter_form.authlist.value.substr(0,idx+1)+document.bookchapter_form.authlist.value.substr(idx+2,32768);
    idx=document.bookchapter_form.authlist.value.indexOf(".  ");
  }
  idx=document.bookchapter_form.authlist.value.indexOf(" ,");
  while (idx > 0) {
    document.bookchapter_form.authlist.value=document.bookchapter_form.authlist.value.substr(0,idx)+document.bookchapter_form.authlist.value.substr(idx+1,32768);
    idx=document.bookchapter_form.authlist.value.indexOf(" ,");
  }
  for (n=0; n < document.bookchapter_form.authlist.value.length; n++) {
    if ((n+1) < document.bookchapter_form.authlist.value.length) {
	if (document.bookchapter_form.authlist.value.charAt(n) == '.' && document.bookchapter_form.authlist.value.charAt(n+1) >= 'A' && document.bookchapter_form.authlist.value.charAt(n+1) <= 'Z')
	  document.bookchapter_form.authlist.value=document.bookchapter_form.authlist.value.substr(0,n+1)+' '+document.bookchapter_form.authlist.value.substr(n+1,32768);
    }
  }
  if (document.bookchapter_form.pubyear.value.length == 0) {
    alert("Enter the year of publication");
    return false;
  }
  if (document.bookchapter_form.pubyear.value.length != 4) {
    alert("Enter a valid year of publication");
    return false;
  }
  if (document.bookchapter_form.pubtitle.value.length == 0) {
    alert("Enter the publication title");
    return false;
  }
  if (document.bookchapter_form.booktitle.value.length == 0) {
    alert("Enter the name of the book");
    return false;
  }
  if (document.bookchapter_form.editor.value.length == 0) {
    alert("Enter the name(s) of the editor(s)");
    return false;
  }
  if (document.bookchapter_form.publisher.value.length == 0) {
    alert("Enter the publisher");
    return false;
  }
  if (document.bookchapter_form.pages.value.length == 0) {
    alert("Enter the pages");
    return false;
  }
  for (n=0; n < document.bookchapter_form.pages.value.length; n++) {
    c=document.bookchapter_form.pages.value.charAt(n);
    if ((c < '0' || c > '9') && c != '-') {
	alert("Enter the pages as NN-nn");
	return false;
    }
  }
  if (document.bookchapter_form.pages.value.indexOf("-") < 0) {
    alert("Enter the pages as 'NN-nn'");
    return false;
  }
  if (document.bookchapter_form.doi.value.length > 0 && (document.bookchapter_form.doi.value.indexOf("10.") != 0 || document.bookchapter_form.doi.value.length < 9 || document.bookchapter_form.doi.value.indexOf("/") != 7)) {
    alert("The DOI must be of the form '10.nnnn/X...'.  Please enter a valid DOI.");
    return false;
  }
  c=document.bookchapter_form.authlist.value.charAt(document.bookchapter_form.authlist.value.length-1);
  while (c == ' ') {
    document.bookchapter_form.authlist.value=document.bookchapter_form.authlist.value.substr(0,document.bookchapter_form.authlist.value.length-1);
    c=document.bookchapter_form.authlist.value.charAt(document.bookchapter_form.authlist.value.length-1);
  }
  c=document.bookchapter_form.pubyear.value.charAt(document.bookchapter_form.pubyear.value.length-1);
  while (c < '0' || c > '9') {
    document.bookchapter_form.pubyear.value=document.bookchapter_form.pubyear.value.substr(0,document.bookchapter_form.pubyear.value.length-1);
    c=document.bookchapter_form.pubyear.value.charAt(document.bookchapter_form.pubyear.value.length-1);
  }
  c=document.bookchapter_form.pubtitle.value.charAt(document.bookchapter_form.pubtitle.value.length-1);
  while (c == ' ' || c == '.') {
    document.bookchapter_form.pubtitle.value=document.bookchapter_form.pubtitle.value.substr(0,document.bookchapter_form.pubtitle.value.length-1);
    c=document.bookchapter_form.pubtitle.value.charAt(document.bookchapter_form.pubtitle.value.length-1);
  }
  while ( (idx=document.bookchapter_form.pubtitle.value.indexOf('"')) >= 0)
    document.bookchapter_form.pubtitle.value=document.bookchapter_form.pubtitle.value.substring(0,idx)+document.bookchapter_form.pubtitle.value.substring(idx+1);
  c=document.bookchapter_form.booktitle.value.charAt(document.bookchapter_form.booktitle.value.length-1);
  while (c == ' ' || c == '.') {
    document.bookchapter_form.booktitle.value=document.bookchapter_form.booktitle.value.substr(0,document.bookchapter_form.booktitle.value.length-1);
    c=document.bookchapter_form.booktitle.value.charAt(document.bookchapter_form.booktitle.value.length-1);
  }
  c=document.bookchapter_form.editor.value.charAt(document.bookchapter_form.editor.value.length-1);
  while ((c < 'a' || c > 'z') && (c < 'A' || c > 'Z')) {
    document.bookchapter_form.editor.value=document.bookchapter_form.editor.value.substr(0,document.bookchapter_form.editor.value.length-1);
    c=document.bookchapter_form.editor.value.charAt(document.bookchapter_form.editor.value.length-1);
  }
  c=document.bookchapter_form.publisher.value.charAt(document.bookchapter_form.publisher.value.length-1);
  while ((c < 'a' || c > 'z') && (c < 'A' || c > 'Z') && (c < '0' || c > '9')) {
    document.bookchapter_form.publisher.value=document.bookchapter_form.publisher.value.substr(0,document.bookchapter_form.publisher.value.length-1);
    c=document.bookchapter_form.publisher.value.charAt(document.bookchapter_form.publisher.value.length-1);
  }
  var i='book_chapter[!]'+document.bookchapter_form.authlist.value+'[!]'+document.bookchapter_form.pubyear.value+'[!]'+document.bookchapter_form.pubtitle.value+'[!]'+document.bookchapter_form.editor.value+'[+]'+document.bookchapter_form.publisher.value+'[+]'+document.bookchapter_form.pages.value+'[+]'+document.bookchapter_form.booktitle.value;
  i += '[!]ds_rel:' + document.bookchapter_form.ds_rel[document.bookchapter_form.ds_rel.selectedIndex].value;
  if (document.bookchapter_form.doi.value.length > 0) {
    i+='[!]doi:'+document.bookchapter_form.doi.value;
  }
  if (document.bookchapter_form.annotation.value.length > 0) {
    i+='[!]comment:'+document.bookchapter_form.annotation.value;
  }
  {% if 'replace_item' in data %}
  replaceItem('references_field', '{{ data.replace_item }}', i);
  {% else %}
  addItem('references_field', i);
  {% endif %}
  return true;
}
</script>
<center>
    <h2>{% if 'replace_item' in data %}Edit{% else %}Add{% endif %} a Book Chapter Reference</h2>
</center>
<p>
    Required fields are denoted by a <font color="red"><span class="var18">*</span></font>.  All other fields are optional.
</p>
<form name="bookchapter_form" action="javascript:void(0)" onsubmit="return checkBookChapterForm()">
    <div class="component two-column container-lg overflow-hidden mb-3">
        <div class="row gx-0 gx-md-1 mt-1">
            <div class="col-12 col-md-2"></div>
            <div class="col-12 col-md-8">
                <font color="red"><span class="body-font-large">*</span></font>Relationship to the dataset:
                <select class="d-block" name="ds_rel">
                    <option>(choose one)</option>
                    {% for option in data.relation_options %}
                    <option value="{{ option.value }}" {% if 'ds_rel' in data and data.ds_rel == option.value %}selected{% endif %}>The dataset {{ option.description }} this book chapter.</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="row gx-0 gx-md-1 mt-1">
            <div class="col-12 col-md-2"></div>
            <div class="col-12 col-md-8">
                <font color="red"><span class="var18">*</span></font>Author(s):<br><input type="text" class="fixedWidth14" name="authlist" size="80" value="{% if 'authors' in data %}{{ data.authors }}{% endif %}">
            </div>
        </div>
        <div class="row gx-0 gx-md-1 mt-1">
            <div class="col-12 col-md-2"></div>
            <div class="col-12 col-md-8">
                <font color="red"><span class="var18">*</span></font>Year Published:&nbsp;<input type="text" class="fixedWidth14" name="pubyear" size="4" maxlength="4" value="{% if 'pub_year' in data %}{{ data.pub_year }}{% endif %}">
            </div>
        </div>
        <div class="row gx-0 gx-md-1 mt-1">
            <div class="col-12 col-md-2"></div>
            <div class="col-12 col-md-8">
                <font color="red"><span class="var18">*</span></font>Title of Chapter in the book:<br><input type="text" class="fixedWidth14" name="pubtitle" size="80" value="{% if 'pub_title' in data %}{{ data.pub_title }}{% endif %}">
            </div>
        </div>
        <div class="row gx-0 gx-md-1 mt-1">
            <div class="col-12 col-md-2"></div>
            <div class="col-12 col-md-8">
                <font color="red"><span class="var18">*</span></font>Title of the book:<br><input type="text" class="fixedWidth14" name="booktitle" size="80" value="{% if 'book_title' in data %}{{ data.book_title }}{% endif %}">
            </div>
        </div>
        <div class="row gx-0 gx-md-1 mt-1">
            <div class="col-12 col-md-2"></div>
            <div class="col-12 col-md-8">
                <font color="red"><span class="var18">*</span></font>Editor(s):<br><input type="text" class="fixedWidth14" name="editor" size="80" value="{% if 'editor' in data %}{{ data.editor }}{% endif %}">
            </div>
        </div>
        <div class="row gx-0 gx-md-1 mt-1">
            <div class="col-12 col-md-2"></div>
            <div class="col-12 col-md-8">
                <font color="red"><span class="var18">*</span></font>Publisher:<br><input type="text" class="fixedWidth14" name="publisher" size="80" value="{% if 'publisher' in data %}{{ data.publisher }}{% endif %}">
            </div>
        </div>
        <div class="row gx-0 gx-md-1 mt-1">
            <div class="col-12 col-md-2"></div>
            <div class="col-12 col-md-8">
                <font color="red"><span class="var18">*</span></font>Pages (as NN-nn):<br><input type="text" class="fixedWidth14" name="pages" size="15" value="{% if 'pages' in data %}{{ data.pages }}{% endif %}"><sup><font color="blue">$</font></sup>
           </div>
        </div>
        <div class="row gx-0 gx-md-1 mt-1">
            <div class="col-12 col-md-2"></div>
            <div class="col-12 col-md-8">
                Digital Object Identifier: (prefix/suffix only, e.g. - <i>10.1002/joc.1166</i>)<br /><input type="text" class="fixedWidth14" name="doi" size="80" value="{% if 'doi' in data %}{{ data.doi }}{% endif %}">
            </div>
        </div>
        <div class="row gx-0 gx-md-1 mt-1">
            <div class="col-12 col-md-2"></div>
            <div class="col-12 col-md-8">
                Annotation (which will appear just below the reference; no HTML allowed):<br /><input type="text" class="fixedWidth14" name="annotation" size="80" value="{% if 'annotation' in data %}{{ data.annotation }}{% endif %}" />
            </div>
        </div>
    </div>
    <sup><font color="blue">$</font></sup> <small>For a book chapter that is In Press, enter "0-0" for the Page Range
    <center class="mt-3">
        <button class="btn btn-primary px-2 py-1 border-1" onclick="document.bookchapter_form.submit()">{% if 'replace_item' in data %}Save Changes{% else %}Add Reference {% endif %}</button>
    </center>
</form>
